<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—é‡å¤åº¦åˆ†æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #856404;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-analyze:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-clear {
            background: #ff6b6b;
            color: white;
        }

        .btn-clear:hover {
            background: #ee5a5a;
        }

        .progress-section {
            display: none;
            margin: 25px 0;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 25px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .stats-section {
            display: none;
            background: #f0f7ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .results-section {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .results-header h2 {
            color: #333;
            font-size: 20px;
        }

        .filter-options {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-options label {
            margin-bottom: 0;
            font-weight: normal;
        }

        .filter-options input[type="number"] {
            width: 80px;
            padding: 8px;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .log-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .log-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }

        .log-table tr:hover {
            background: #f8f9fa;
        }

        .rank {
            width: 60px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        .percentage {
            width: 100px;
            text-align: center;
        }

        .percentage-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
        }

        .percentage-high {
            background: #ff6b6b;
            color: white;
        }

        .percentage-medium {
            background: #ffa502;
            color: white;
        }

        .percentage-low {
            background: #20bf6b;
            color: white;
        }

        .count {
            width: 80px;
            text-align: center;
            color: #666;
        }

        .importance {
            width: 90px;
            text-align: center;
        }

        .importance-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .importance-high {
            background: #ff6b6b;
            color: white;
        }

        .importance-medium {
            background: #ffa502;
            color: white;
        }

        .importance-low {
            background: #20bf6b;
            color: white;
        }

        .suggestion-tag {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .log-content {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            word-break: break-all;
            line-height: 1.5;
            max-width: 600px;
        }

        .sample-section {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .sample-title {
            font-size: 11px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .sample-item {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 11px;
            color: #555;
            padding: 6px 0;
            border-bottom: 1px dashed #e0e0e0;
            word-break: break-all;
        }

        .sample-item:last-child {
            border-bottom: none;
        }

        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            width: 60px;
            font-size: 12px;
            color: #666;
            text-align: right;
        }

        .bar-wrapper {
            flex: 1;
            background: #e0e0e0;
            border-radius: 4px;
            height: 30px;
            overflow: hidden;
        }

        .bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .export-btn {
            background: #20bf6b;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .export-btn:hover {
            background: #1ea864;
        }

        .error-message {
            display: none;
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #d63031;
        }

        .settings-toggle {
            cursor: pointer;
            color: #667eea;
            text-decoration: underline;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        .settings-panel {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .settings-panel.show {
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        select {
            cursor: pointer;
        }

        .realtime-results {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 8px;
            border-left: 4px solid #20bf6b;
            display: none;
        }

        .realtime-header {
            font-weight: bold;
            color: #20bf6b;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .realtime-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .realtime-stat {
            font-size: 13px;
            color: #666;
        }

        .realtime-stat strong {
            color: #333;
        }

        .realtime-preview {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 4px;
            padding: 10px;
            border: 1px solid #e0e0e0;
        }

        .realtime-item {
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }

        .realtime-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æ—¥å¿—é‡å¤åº¦åˆ†æå·¥å…·</h1>

        <div class="error-message" id="errorMessage"></div>

        <div class="input-section">
            <div class="input-group">
                <label>ğŸ“ æ—¥å¿—ç›®å½•è·¯å¾„</label>
                <input type="text" id="directoryInput" 
                       placeholder="ä¾‹å¦‚: G:\path\to\logs"
                       value="G:\[________________]\DiagnosticLog-171-1766458290-sf\iOADiagnosisLog-Full-2025-12-23-10-52-51\diagnosis_export\ZtsmEnt">
            </div>

            <div class="input-group">
                <label>ğŸ” æ—¥å¿—æ–‡ä»¶åŒ¹é…æ¨¡å¼ï¼ˆæ”¯æŒé€šé…ç¬¦ * å’Œ ?ï¼‰</label>
                <input type="text" id="patternInput" 
                       placeholder="ä¾‹å¦‚: ZtsmEnt_*.log"
                       value="ZtsmEnt_*.log">
            </div>

            <div class="warning-box">
                âš ï¸ <strong>ç®—æ³•é€‰æ‹©å»ºè®®ï¼š</strong>æ—¥å¿—é€šå¸¸åŒ…å«æ—¶é—´æˆ³ã€æ•°å­—IDç­‰å˜é‡ï¼Œæ¨èä½¿ç”¨æ¨¡ç³ŠåŒ¹é…ç®—æ³•ã€‚
                <ul style="margin-left:20px;margin-top:5px;">
                    <li><strong>Levenshteinï¼ˆæ¨èï¼‰</strong>ï¼šé€‚åˆè¯†åˆ«æœ‰å¾®å°å·®å¼‚çš„é‡å¤æ—¥å¿—ï¼ˆæ•°å­—ã€æ—¶é—´å˜åŒ–ç­‰ï¼‰</li>
                    <li>N-gramï¼šé€‚åˆå±€éƒ¨å­—ç¬¦ç›¸ä¼¼ï¼Œå¯¹é¡ºåºå˜åŒ–ä¸å¤ªæ•æ„Ÿ</li>
                    <li>Jaccardï¼šé€‚åˆç”¨è¯ç›¸ä¼¼ä½†é¡ºåºä¸åŒçš„æ—¥å¿—</li>
                    <li>ä½™å¼¦ç›¸ä¼¼åº¦ï¼šåŸºäºè¯é¢‘ï¼Œæœ€ç²¾ç¡®ä½†è®¡ç®—æ…¢</li>
                    <li>ç²¾ç¡®åŒ¹é…ï¼šä»…é€‚ç”¨äºç¡®å®šæ— å˜é‡çš„åœºæ™¯</li>
                </ul>
            </div>

            <div class="warning-box" style="background:#d1ecf1;border-color:#17a2b8;color:#0c5460;">
                ğŸ’¡ <strong>æ—¥å¿—åˆ†æä¼˜åŒ–å»ºè®®ï¼š</strong>
                <ul style="margin-left:20px;margin-top:5px;">
                    <li>TRACE/DEBUGçº§åˆ«æ—¥å¿—å»ºè®®è°ƒæ•´æ—¥å¿—ç­‰çº§ï¼Œå‡å°‘è¾“å‡º</li>
                    <li>å‡½æ•°è¿›å…¥/è¿”å›æ—¥å¿—ï¼ˆEnter Function/retï¼‰å»ºè®®æ”¹ä¸ºERRORçº§åˆ«æˆ–å…³é—­</li>
                    <li>é¢‘ç¹çš„é…ç½®è¯»å–ã€ä»£ç†è®¾ç½®ç­‰æ—¥å¿—å»ºè®®é™ä½çº§åˆ«</li>
                    <li>å·¥å…·ä¼šè‡ªåŠ¨è¯†åˆ«ä½ä»·å€¼æ—¥å¿—å¹¶ç»™å‡ºä¼˜åŒ–å»ºè®®</li>
                </ul>
            </div>

            <div class="warning-box" style="background:#e7f3ff;border-color:#0066cc;color:#003366;">
                ğŸ“Œ <strong>é‡è¦æç¤ºï¼š</strong>æ—¥å¿—å‰ç¼€ï¼ˆæ—¶é—´æˆ³ã€è¿›ç¨‹IDã€æ¨¡å—åç­‰ï¼‰ä¼šè‡ªåŠ¨è¢«å¿½ç•¥ï¼Œä¸ä¼šå‚ä¸é‡å¤åº¦è®¡ç®—ã€‚
                <br>å¦‚æœæ‚¨çš„æ—¥å¿—æ ¼å¼ç‰¹æ®Šï¼Œè¯·åœ¨é«˜çº§è®¾ç½®ä¸­é…ç½®"å¿½ç•¥å‰ç¼€æ¨¡å¼"ã€‚
            </div>

            <span class="settings-toggle" id="settingsToggle">âš™ï¸ é«˜çº§è®¾ç½®</span>
            <div class="settings-panel" id="settingsPanel">
                <div class="input-group">
                    <label>ğŸ¯ é‡å¤æ—¥å¿—åŒ¹é…ç®—æ³•</label>
                    <select id="algorithmSelect" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;">
                        <option value="fuzzy" selected>æ¨¡ç³ŠåŒ¹é…-Levenshteinï¼ˆæ¨èï¼‰- è¯†åˆ«å¾®å°å·®å¼‚çš„é‡å¤æ—¥å¿—</option>
                        <option value="ngram">N-gramåŒ¹é…ï¼ˆä¸­ç­‰é€Ÿåº¦ï¼‰- åŸºäºNå…ƒç»„é‡å åº¦</option>
                        <option value="jaccard">Jaccardç›¸ä¼¼åº¦ï¼ˆä¸­ç­‰é€Ÿåº¦ï¼‰- åŸºäºè¯æ±‡é›†åˆé‡å </option>
                        <option value="cosine">ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆè¾ƒæ…¢ï¼‰- åŸºäºè¯å‘é‡</option>
                        <option value="exact">ç²¾ç¡®åŒ¹é…ï¼ˆæœ€å¿«ï¼Œä¸æ¨èï¼‰- å®Œå…¨ç›¸åŒçš„æ—¥å¿—æ‰ç®—é‡å¤</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ğŸ“ æ—¥å¿—å‰ç¼€å¿½ç•¥æ¨¡å¼ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰</label>
                    <input type="text" id="ignorePrefixPattern" placeholder="ä¾‹å¦‚: ^\[[^\]]+\]\[[^\]]+\]\[[^\]]+\]\[[^\]]+\]\[[^\]]+\]">
                    <div style="font-size:11px;color:#666;margin-top:5px;">
                        ğŸ’¡ ç”¨äºåŒ¹é…å¹¶ç§»é™¤æ—¥å¿—è¡Œçš„å‰ç¼€éƒ¨åˆ†ï¼ˆå¦‚æ—¶é—´æˆ³ã€è¿›ç¨‹IDç­‰ï¼‰ï¼ŒåŒ¹é…åˆ°çš„å†…å®¹å°†è¢«ç§»é™¤åå†è¿›è¡Œé‡å¤åº¦è®¡ç®—ã€‚
                        <br>ç•™ç©ºåˆ™ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹çš„é»˜è®¤æ ¼å¼ï¼š<code style="background:#eee;padding:2px 4px;border-radius:3px;">^\[[^\]]+\]\[[^\]]+\]\[[^\]]+\]\[[^\]]+->[^\]]+@\d+@\w+\]:</code>
                    </div>
                </div>
                <div class="input-group">
                    <label>ğŸ”§ å¸¸ç”¨æ—¥å¿—æ ¼å¼é¢„è®¾</label>
                    <select id="logFormatPreset" style="width:100%;padding:8px;border:2px solid #ddd;border-radius:6px;font-size:13px;">
                        <option value="auto">è‡ªåŠ¨æ£€æµ‹ï¼ˆæ¨èï¼‰</option>
                        <option value="iOA">iOAä¼ä¸šç‰ˆæ ¼å¼</option>
                        <option value="apache">Apache/Nginxæ ¼å¼</option>
                        <option value="system">ç³»ç»Ÿæ—¥å¿—æ ¼å¼</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="input-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="ignoreNumbers" checked>
                        <label for="ignoreNumbers">å¿½ç•¥æ•°å­—ï¼ˆè¯†åˆ«æ¨¡æ¿æ—¥å¿—ï¼‰</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0-100ï¼Œå€¼è¶Šé«˜è¦æ±‚è¶Šä¸¥æ ¼ï¼‰</label>
                    <input type="number" id="similarityThreshold" value="70" min="0" max="100">
                </div>
                <div class="input-group">
                    <label>æœ€å°é‡å¤æ¬¡æ•°é˜ˆå€¼</label>
                    <input type="number" id="minRepeatCount" value="5" min="1">
                </div>
                <div class="input-group">
                    <label>è¿‡æ»¤è¿‡çŸ­æ—¥å¿—ï¼ˆæœ€å°å­—ç¬¦æ•°ï¼‰</label>
                    <input type="number" id="minLineLength" value="20" min="1">
                </div>
                <div class="input-group">
                    <label>æ¯ä¸ªæ—¥å¿—ç»„æ˜¾ç¤ºçš„éšæœºæ ·æœ¬æ•°</label>
                    <input type="number" id="sampleCount" value="3" min="1" max="10">
                </div>
                <div class="input-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showRealtime" checked>
                        <label for="showRealtime">å®æ—¶æ˜¾ç¤ºä¸­é—´ç»“æœï¼ˆæ¯å¤„ç†ä¸€å®šæ•°é‡æ—¥å¿—åæ›´æ–°ï¼‰</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>å®æ—¶æ›´æ–°é—´éš”ï¼ˆå¤„ç†å¤šå°‘è¡Œåæ›´æ–°ä¸€æ¬¡ï¼‰</label>
                    <input type="number" id="realtimeInterval" value="5000" min="1000" max="50000" step="1000">
                </div>
            </div>

            <div class="btn-container">
                <button class="btn-analyze" id="analyzeBtn" onclick="analyzeLogs()">ğŸ” å¼€å§‹åˆ†æ</button>
                <button class="btn-clear" id="stopBtn" onclick="stopAnalysis()" style="display:none;background:#ffa502;">â¹ï¸ åœæ­¢åˆ†æ</button>
                <button class="btn-clear" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
            <div class="realtime-results" id="realtimeResults">
                <div class="realtime-header">â±ï¸ å®æ—¶ä¸­é—´ç»“æœ</div>
                <div class="realtime-stats">
                    <span class="realtime-stat">å·²å¤„ç†: <strong id="realtimeProcessed">0</strong> è¡Œ</span>
                    <span class="realtime-stat">å½“å‰é‡å¤: <strong id="realtimeDuplicates">0</strong> ç§</span>
                    <span class="realtime-stat">å½“å‰Topé‡å¤: <strong id="realtimeTopCount">0</strong> æ¬¡</span>
                </div>
                <div class="realtime-preview" id="realtimePreview"></div>
            </div>
        </div>

        <div class="stats-section" id="statsSection">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalFiles">0</div>
                    <div class="stat-label">åˆ†ææ–‡ä»¶æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalLines">0</div>
                    <div class="stat-label">æ€»æ—¥å¿—è¡Œæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uniqueLogs">0</div>
                    <div class="stat-label">å”¯ä¸€æ—¥å¿—æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="duplicateRate">0%</div>
                    <div class="stat-label">é‡å¤ç‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="usedAlgorithm" style="font-size:16px;">-</div>
                    <div class="stat-label">ä½¿ç”¨ç®—æ³•</div>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>ğŸ“‹ é‡å¤æ—¥å¿—åˆ†æç»“æœ</h2>
                <div class="filter-options">
                    <label>æ˜¾ç¤ºå‰</label>
                    <input type="number" id="topN" value="20" min="1" max="1000">
                    <label>æ¡</label>
                    <button class="export-btn" onclick="exportResults()">ğŸ“¥ å¯¼å‡ºCSV</button>
                </div>
            </div>

            <table class="log-table">
                <thead>
                    <tr>
                        <th class="rank">æ’å</th>
                        <th class="percentage">å æ¯”</th>
                        <th class="count">é‡å¤æ¬¡æ•°</th>
                        <th class="importance">é‡è¦æ€§</th>
                        <th class="log-content">æ—¥å¿—æ¨¡æ¿</th>
                    </tr>
                </thead>
                <tbody id="resultsTable">
                </tbody>
            </table>

            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ TOP 10 é‡å¤æ—¥å¿—åˆ†å¸ƒ</div>
                <div class="bar-chart" id="barChart"></div>
            </div>
        </div>
    </div>

    <script>
        let analysisResults = [];
        let isAnalyzing = false;
        let realtimeUpdateTimer = null;
        let stopRequested = false; // åœæ­¢è¯·æ±‚æ ‡å¿—

        // åˆ‡æ¢é«˜çº§è®¾ç½®é¢æ¿
        document.getElementById('settingsToggle').addEventListener('click', function() {
            document.getElementById('settingsPanel').classList.toggle('show');
        });

        // æ—¥å¿—æ ¼å¼é¢„è®¾åˆ‡æ¢
        document.getElementById('logFormatPreset').addEventListener('change', function() {
            const preset = this.value;
            const patterns = {
                'auto': '',
                'iOA': '^\\[[^\\]]+\\]\\[[^\\]]+\\]\\[[^\\]]+\\]\\[[^\\]]+\\-\\>[^\\]]+@\\d+@\\w+\\]:',
                'apache': '^\\[[^\\]]+\\] \\[[^\\]]+\\]',
                'system': '^[A-Za-z]{3}\\s+\\d{1,2}\\s+\\d{2}:\\d{2}:\\d{2}\\s+',
                'custom': ''
            };
            document.getElementById('ignorePrefixPattern').value = patterns[preset] || '';
        });

        // ============ å¤šç§ç›¸ä¼¼åº¦ç®—æ³•å®ç° ============

        // ç®—æ³•1: Levenshteinç¼–è¾‘è·ç¦»ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
        function levenshteinDistance(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;

            if (len1 === 0) return len2;
            if (len2 === 0) return len1;

            // å¦‚æœå­—ç¬¦ä¸²å¤ªé•¿ï¼Œä½¿ç”¨ç®€åŒ–çš„æ¯”è¾ƒ
            if (len1 > 500 || len2 > 500) {
                return simpleDistance(str1, str2);
            }

            const matrix = [];

            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j - 1] + cost
                    );
                }
            }

            return matrix[len1][len2];
        }

        // ç®€åŒ–çš„è·ç¦»è®¡ç®—ï¼ˆç”¨äºé•¿å­—ç¬¦ä¸²ï¼‰
        function simpleDistance(str1, str2) {
            const len1 = Math.min(str1.length, 200);
            const len2 = Math.min(str2.length, 200);

            const prefix1 = str1.substring(0, len1);
            const prefix2 = str2.substring(0, len2);

            const words1 = new Set(prefix1.split(/\s+/).filter(w => w.length > 2));
            const words2 = new Set(prefix2.split(/\s+/).filter(w => w.length > 2));

            let common = 0;
            words1.forEach(word => {
                if (words2.has(word)) common++;
            });

            const total = Math.max(words1.size, words2.size);
            if (total === 0) return 0;

            return Math.floor((total - common) * 3);
        }

        // ç®—æ³•2: N-gramç›¸ä¼¼åº¦
        function ngramSimilarity(str1, str2, n = 2) {
            if (str1 === str2) return 100;
            if (!str1 || !str2) return 0;

            const ngrams1 = getNGrams(str1, n);
            const ngrams2 = getNGrams(str2, n);

            if (ngrams1.size === 0 && ngrams2.size === 0) return 100;

            let common = 0;
            ngrams1.forEach(ngram => {
                if (ngrams2.has(ngram)) common++;
            });

            const union = ngrams1.size + ngrams2.size - common;
            return union === 0 ? 100 : (common / union) * 100;
        }

        function getNGrams(str, n) {
            const ngrams = new Set();
            for (let i = 0; i <= str.length - n; i++) {
                ngrams.add(str.substring(i, i + n));
            }
            return ngrams;
        }

        // ç®—æ³•3: Jaccardç›¸ä¼¼åº¦ï¼ˆåŸºäºè¯æ±‡é›†åˆï¼‰
        function jaccardSimilarity(str1, str2) {
            if (str1 === str2) return 100;
            if (!str1 || !str2) return 0;

            const words1 = new Set(str1.toLowerCase().split(/\s+/).filter(w => w.length > 1));
            const words2 = new Set(str2.toLowerCase().split(/\s+/).filter(w => w.length > 1));

            if (words1.size === 0 && words2.size === 0) return 100;

            let intersection = 0;
            words1.forEach(word => {
                if (words2.has(word)) intersection++;
            });

            const union = words1.size + words2.size - intersection;
            return union === 0 ? 100 : (intersection / union) * 100;
        }

        // ç®—æ³•4: ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆåŸºäºè¯é¢‘å‘é‡ï¼‰
        function cosineSimilarity(str1, str2) {
            if (str1 === str2) return 100;
            if (!str1 || !str2) return 0;

            const words1 = str1.toLowerCase().split(/\s+/).filter(w => w.length > 1);
            const words2 = str2.toLowerCase().split(/\s+/).filter(w => w.length > 1);

            if (words1.length === 0 && words2.length === 0) return 100;

            const freq1 = {};
            const freq2 = {};
            const allWords = new Set([...words1, ...words2]);

            words1.forEach(word => freq1[word] = (freq1[word] || 0) + 1);
            words2.forEach(word => freq2[word] = (freq2[word] || 0) + 1);

            let dotProduct = 0;
            let norm1 = 0;
            let norm2 = 0;

            allWords.forEach(word => {
                const f1 = freq1[word] || 0;
                const f2 = freq2[word] || 0;
                dotProduct += f1 * f2;
                norm1 += f1 * f1;
                norm2 += f2 * f2;
            });

            if (norm1 === 0 || norm2 === 0) return 0;
            return (dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2))) * 100;
        }

        // ç»Ÿä¸€çš„ç›¸ä¼¼åº¦è®¡ç®—æ¥å£
        function calculateSimilarity(str1, str2, algorithm = 'fuzzy') {
            switch (algorithm) {
                case 'fuzzy':
                case 'levenshtein':
                    // Levenshteinç›¸ä¼¼åº¦
                    if (str1 === str2) return 100;
                    if (!str1 || !str2) return 0;
                    const maxLen = Math.max(str1.length, str2.length);
                    if (maxLen === 0) return 100;
                    const distance = levenshteinDistance(str1, str2);
                    return Math.max(0, Math.min(100, ((maxLen - distance) / maxLen) * 100));
                case 'ngram':
                    return ngramSimilarity(str1, str2, 2);
                case 'jaccard':
                    return jaccardSimilarity(str1, str2);
                case 'cosine':
                    return cosineSimilarity(str1, str2);
                case 'exact':
                default:
                    return str1 === str2 ? 100 : 0;
            }
        }

        // è§£ææ—¥å¿—è¡Œï¼Œæå–æ ¸å¿ƒå†…å®¹å’Œå…ƒæ•°æ®
        function parseLogLine(line) {
            // é¦–å…ˆå°è¯•ç”¨æˆ·è‡ªå®šä¹‰çš„å¿½ç•¥æ¨¡å¼
            const customPattern = document.getElementById('ignorePrefixPattern')?.value?.trim();
            if (customPattern) {
                try {
                    const customRegex = new RegExp(customPattern);
                    const customMatch = line.match(customRegex);
                    if (customMatch) {
                        return {
                            content: line.substring(customMatch[0].length).trim(),
                            rawPrefix: customMatch[0],
                            level: '',
                            timestamp: '',
                            processInfo: '',
                            module: '',
                            sourceFile: '',
                            lineNo: ''
                        };
                    }
                } catch (e) {
                    console.warn('è‡ªå®šä¹‰æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼:', e.message);
                }
            }

            // åŒ¹é…æ—¥å¿—å‰ç¼€: [LEVEL][TIME][PID TID][MODULE->FILE@LINE]:
            const logPrefixRegex = /^\[(\w+)\]\[([^\]]+)\]\[([^\]]+)\]\[([^\]]+)->([^\]]+)@(\d+)@\w+\]:\s*(.*)$/;
            const match = line.match(logPrefixRegex);

            if (match) {
                return {
                    level: match[1],
                    timestamp: match[2],
                    processInfo: match[3],
                    module: match[4],
                    sourceFile: match[5],
                    lineNo: match[6],
                    content: match[7],
                    rawPrefix: match[0].substring(0, match[0].lastIndexOf(':') + 1)
                };
            }

            // å°è¯•å…¶ä»–å¸¸è§æ ¼å¼
            const simpleRegex = /^\[(\w+)\]\[([^\]]+)\](.*)$/;
            const simpleMatch = line.match(simpleRegex);

            if (simpleMatch) {
                return {
                    level: simpleMatch[1],
                    timestamp: simpleMatch[2],
                    content: simpleMatch[3],
                    rawPrefix: simpleMatch[0]
                };
            }

            return {
                content: line,
                rawPrefix: ''
            };
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆæ—¥å¿—è¡Œï¼ˆè¿‡æ»¤æ‰åªæœ‰ç¬¦å·çš„è¡Œï¼‰
        function isValidLogLine(line) {
            const minLineLength = parseInt(document.getElementById('minLineLength').value) || 10;
            if (line.length < minLineLength) return false;

            // ç§»é™¤æ‰€æœ‰ç¬¦å·å’Œç©ºç™½
            const stripped = line.replace(/[{}[\](),;:.\/\s\n\r\t]/g, '');
            return stripped.length > 0;
        }

        // æµå¼è¯»å–æ–‡ä»¶å†…å®¹ï¼Œé¿å…å†…å­˜çˆ†ç‚¸
        async function* readFileInChunks(file, chunkSize = 1024 * 1024) { // 1MB chunks
            const reader = file.stream().getReader();
            let buffer = '';
            let position = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const decoder = new TextDecoder('utf-8', { stream: true });
                const chunk = buffer + decoder.decode(value, { stream: true });

                // æŒ‰è¡Œåˆ†å‰²
                const lines = chunk.split('\n');
                // ä¿ç•™æœ€åä¸€è¡Œï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰
                buffer = lines.pop() || '';

                for (const line of lines) {
                    yield line;
                }

                position += value.length;
            }

            // å¤„ç†æœ€åä¸€è¡Œ
            if (buffer) {
                yield buffer;
            }
        }

        async function analyzeLogs() {
            if (isAnalyzing) return;
            isAnalyzing = true;
            stopRequested = false;

            const directory = document.getElementById('directoryInput').value.trim();
            const pattern = document.getElementById('patternInput').value.trim();
            const algorithm = document.getElementById('algorithmSelect').value;
            const similarityThreshold = parseInt(document.getElementById('similarityThreshold').value) || 70;
            const showRealtime = document.getElementById('showRealtime').checked;
            const realtimeInterval = parseInt(document.getElementById('realtimeInterval').value) || 5000;

            if (!directory) {
                showError('è¯·è¾“å…¥æ—¥å¿—ç›®å½•è·¯å¾„');
                isAnalyzing = false;
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const stopBtn = document.getElementById('stopBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'â³ åˆ†æä¸­...';
            stopBtn.style.display = 'block';

            hideError();
            showProgress();
            document.getElementById('realtimeResults').style.display = showRealtime ? 'block' : 'none';
            updateProgress(0, 'å¼€å§‹åˆ†æ...');

            try {
                const dirHandle = await window.showDirectoryPicker({
                    id: 'log-analyzer-dir',
                    mode: 'read'
                });

                analysisResults = [];
                let totalLines = 0;
                let fileCount = 0;
                const logMap = new Map();
                let lastRealtimeUpdate = 0;

                // è·å–æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶
                const filesToProcess = [];
                for await (const [name, handle] of dirHandle.entries()) {
                    if (handle.kind === 'file' && matchPattern(name, pattern)) {
                        filesToProcess.push({ name, handle });
                    }
                }
                fileCount = filesToProcess.length;

                // æµå¼å¤„ç†æ¯ä¸ªæ–‡ä»¶
                for (let fileIdx = 0; fileIdx < filesToProcess.length; fileIdx++) {
                    // æ£€æŸ¥æ˜¯å¦åœæ­¢
                    if (stopRequested) {
                        updateProgress(Math.max(50, 10 + (fileIdx / filesToProcess.length) * 35), 'åˆ†æå·²åœæ­¢');
                        break;
                    }

                    const { name, handle } = filesToProcess[fileIdx];
                    const fileProgress = 10 + (fileIdx / filesToProcess.length) * 35;
                    updateProgress(fileProgress, `æ­£åœ¨è¯»å–æ–‡ä»¶ (${fileIdx + 1}/${fileCount}): ${name}...`);

                    const file = await handle.getFile();
                    let lineCountInFile = 0;

                    for await (const line of readFileInChunks(file)) {
                        if (stopRequested) break;

                        const trimmedLine = line.trim();
                        if (trimmedLine && isValidLogLine(trimmedLine)) {
                            totalLines++;
                            lineCountInFile++;
                            const normalizedLine = normalizeLine(trimmedLine);

                            if (!logMap.has(normalizedLine)) {
                                logMap.set(normalizedLine, {
                                    count: 0,
                                    samples: []
                                });
                            }

                            const logEntry = logMap.get(normalizedLine);
                            logEntry.count++;

                            if (logEntry.samples.length < 10) {
                                logEntry.samples.push(trimmedLine);
                            }

                            // å®æ—¶æ›´æ–°ä¸­é—´ç»“æœ
                            if (showRealtime && totalLines - lastRealtimeUpdate >= realtimeInterval) {
                                updateRealtimeResults(logMap, totalLines, algorithm);
                                lastRealtimeUpdate = totalLines;
                            }
                        }

                        if (lineCountInFile % 1000 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 0));
                        }
                    }
                }

                // å¦‚æœåœæ­¢äº†ï¼Œè·³è¿‡ç›¸ä¼¼åº¦åˆ†æ
                if (!stopRequested) {
                    updateProgress(50, `æ­£åœ¨è¿›è¡Œ${algorithm}ç®—æ³•çš„ç›¸ä¼¼åº¦åˆ†æ...`);

                    let resultsArray;

                    if (algorithm === 'exact') {
                        resultsArray = Array.from(logMap.entries()).map(([content, data]) => ({
                            content,
                            count: data.count,
                            samples: data.samples,
                            isGroup: false,
                            importanceScore: calculateImportanceScore(parseLogLine(content))
                        }));
                    } else {
                        resultsArray = await groupSimilarLogs(
                            Array.from(logMap.entries()),
                            similarityThreshold,
                            algorithm
                        );
                    }

                    const minRepeatCount = parseInt(document.getElementById('minRepeatCount').value) || 5;
                    resultsArray = resultsArray.filter(item => item.count >= minRepeatCount);

                    resultsArray.sort((a, b) => b.count - a.count);

                    analysisResults = resultsArray;

                    // éšè—å®æ—¶ç»“æœ
                    document.getElementById('realtimeResults').style.display = 'none';

                    updateStats(fileCount, totalLines, logMap.size, analysisResults);
                    displayResults();
                    updateProgress(100, 'åˆ†æå®Œæˆï¼');
                } else {
                    // åœæ­¢åçš„å¤„ç†ï¼šæ˜¾ç¤ºå·²åˆ†æçš„éƒ¨åˆ†ç»“æœ
                    document.getElementById('realtimeResults').style.display = 'none';
                    if (totalLines > 0 && logMap.size > 0) {
                        const partialResults = Array.from(logMap.entries()).map(([content, data]) => ({
                            content,
                            count: data.count,
                            samples: data.samples,
                            isGroup: false,
                            importanceScore: calculateImportanceScore(parseLogLine(content))
                        })).sort((a, b) => b.count - a.count);

                        analysisResults = partialResults;
                        updateStats(fileCount, totalLines, logMap.size, partialResults);
                        displayResults();

                        // æ˜¾ç¤ºåœæ­¢æç¤º
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'warning-box';
                        warningDiv.style.background = '#fff3cd';
                        warningDiv.style.borderColor = '#ffc107';
                        warningDiv.style.color = '#856404';
                        warningDiv.innerHTML = 'âš ï¸ <strong>åˆ†æå·²åœæ­¢</strong> - æ˜¾ç¤ºçš„æ˜¯éƒ¨åˆ†ç»“æœ';
                        document.getElementById('resultsSection').insertBefore(warningDiv, document.getElementById('resultsSection').firstChild);
                    }
                }

            } catch (error) {
                console.error('åˆ†æé”™è¯¯:', error);
                if (!stopRequested) {
                    showError('åˆ†æå¤±è´¥: ' + error.message);
                }
            } finally {
                isAnalyzing = false;
                stopRequested = false;
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ğŸ” å¼€å§‹åˆ†æ';
                document.getElementById('stopBtn').style.display = 'none';
            }
        }

        // åœæ­¢åˆ†æ
        function stopAnalysis() {
            if (isAnalyzing) {
                stopRequested = true;
                const stopBtn = document.getElementById('stopBtn');
                stopBtn.disabled = true;
                stopBtn.textContent = 'â¹ï¸ æ­£åœ¨åœæ­¢...';
            }
        }

        // æ›´æ–°å®æ—¶ä¸­é—´ç»“æœ
        function updateRealtimeResults(logMap, totalLines, algorithm) {
            const previewEl = document.getElementById('realtimePreview');
            const processedEl = document.getElementById('realtimeProcessed');
            const duplicatesEl = document.getElementById('realtimeDuplicates');
            const topCountEl = document.getElementById('realtimeTopCount');

            processedEl.textContent = formatNumber(totalLines);
            duplicatesEl.textContent = formatNumber(logMap.size);

            // è·å–Top 5é‡å¤æ—¥å¿—
            const topLogs = Array.from(logMap.entries())
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);

            if (topLogs.length > 0) {
                topCountEl.textContent = formatNumber(topLogs[0][1].count);

                previewEl.innerHTML = topLogs.map(([content, data], idx) => {
                    const percentage = totalLines > 0 ? ((data.count / totalLines) * 100).toFixed(2) : 0;
                    const truncated = content.length > 80 ? content.substring(0, 80) + '...' : content;
                    return `
                        <div class="realtime-item">
                            <strong>#${idx + 1}</strong> (é‡å¤${data.count}æ¬¡, ${percentage}%): ${escapeHtml(truncated)}
                        </div>
                    `;
                }).join('');
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°å®æ—¶ç»“æœåŒºåŸŸ
            previewEl.scrollTop = 0;
        }

        // ä½¿ç”¨ç›¸ä¼¼åº¦ç®—æ³•èšåˆæ—¥å¿— - æ”¯æŒå¤šç§ç®—æ³•
        async function groupSimilarLogs(logs, threshold, algorithm = 'fuzzy') {
            const groups = [];
            const used = new Set();

            const sortedLogs = logs.sort((a, b) => b[1].count - a[1].count);

            // æ€§èƒ½ä¼˜åŒ–ï¼šåªå¤„ç†å‰1000æ¡é«˜é¢‘æ—¥å¿—
            const maxProcessCount = Math.min(sortedLogs.length, 1000);
            const processLogs = sortedLogs.slice(0, maxProcessCount);

            let processedCount = 0;
            const totalToProcess = processLogs.length;

            // ä½¿ç”¨å“ˆå¸Œæ¡¶å¿«é€Ÿåˆ†ç»„
            const contentHashes = new Map();
            const BUCKET_SIZE = 50;

            for (let i = 0; i < processLogs.length; i++) {
                // æ£€æŸ¥æ˜¯å¦åœæ­¢
                if (stopRequested) break;

                const idx = i;
                if (used.has(idx)) continue;

                const [content, data] = processLogs[idx];

                const lenKey = Math.floor(content.length / BUCKET_SIZE);
                const firstChar = content.charAt(0);
                const bucketKey = `${lenKey}-${firstChar}`;
                const bucket = contentHashes.get(bucketKey) || [];

                let group = {
                    content,
                    count: data.count,
                    samples: [...data.samples],
                    similarCount: 0,
                    isGroup: false,
                    importanceScore: 0
                };

                const similarLogs = [];
                for (const bucketItem of bucket) {
                    const { idx: bucketIdx, content: bucketContent } = bucketItem;
                    if (used.has(bucketIdx)) continue;

                    // å¿«é€Ÿè¿‡æ»¤ï¼šé•¿åº¦å·®å¼‚è¶…è¿‡20%ç›´æ¥è·³è¿‡
                    const lenDiff = Math.abs(content.length - bucketContent.length);
                    if (lenDiff > content.length * 0.2) continue;

                    // ä½¿ç”¨é€‰æ‹©çš„ç®—æ³•è®¡ç®—ç›¸ä¼¼åº¦
                    const similarity = calculateSimilarity(content, bucketContent, algorithm);

                    if (similarity >= threshold) {
                        similarLogs.push({ content: bucketContent, data: bucketItem.data, idx: bucketIdx });
                    }
                }

                // å°†å½“å‰å†…å®¹åŠ å…¥æ¡¶
                bucket.push({ idx, content, data });
                contentHashes.set(bucketKey, bucket);

                if (similarLogs.length > 0) {
                    let totalCount = data.count;
                    let allSamples = [...data.samples];

                    similarLogs.forEach(item => {
                        totalCount += item.data.count;
                        if (allSamples.length < 20) {
                            allSamples = allSamples.concat(item.data.samples.slice(0, 3));
                        }
                        used.add(item.idx);
                        group.similarCount++;
                    });

                    group.count = totalCount;
                    group.samples = allSamples;
                    group.isGroup = true;

                    // æ ¹æ®ç®—æ³•ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡ç­¾
                    const algoLabel = {
                        'fuzzy': 'Levenshtein',
                        'ngram': 'N-gram',
                        'jaccard': 'Jaccard',
                        'cosine': 'ä½™å¼¦'
                    }[algorithm] || algorithm;
                    group.content = `${content} (å·²èšåˆ ${group.similarCount + 1} æ¡ç›¸ä¼¼æ—¥å¿— - ${algoLabel})`;
                }

                group.importanceScore = calculateImportanceScore(parseLogLine(content));

                groups.push(group);
                used.add(idx);

                processedCount++;
                if (processedCount % 30 === 0) {
                    const progress = 50 + (processedCount / totalToProcess) * 45;
                    updateProgress(Math.min(progress, 95), `æ­£åœ¨ä½¿ç”¨${algorithm}ç®—æ³•èšåˆç›¸ä¼¼æ—¥å¿— (${processedCount}/${totalToProcess})...`);
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }

            // æ·»åŠ å‰©ä½™çš„ä½é¢‘æ—¥å¿—
            for (let i = maxProcessCount; i < sortedLogs.length; i++) {
                if (stopRequested) break;
                if (!used.has(i)) {
                    const [content, data] = sortedLogs[i];
                    const group = {
                        content,
                        count: data.count,
                        samples: data.samples,
                        isGroup: false,
                        importanceScore: calculateImportanceScore(parseLogLine(content))
                    };
                    groups.push(group);
                }
            }

            return groups;
        }

        function matchPattern(filename, pattern) {
            const regexPattern = pattern
                .replace(/\./g, '\\.')
                .replace(/\*/g, '.*')
                .replace(/\?/g, '.');
            const regex = new RegExp(`^${regexPattern}$`, 'i');
            return regex.test(filename);
        }

        function normalizeLine(line) {
            const parsed = parseLogLine(line);
            let normalized = parsed.content || line;

            // å¦‚æœè§£ææˆåŠŸï¼Œè¯´æ˜å‰ç¼€å·²ç»è¢«ç§»é™¤ï¼Œç›´æ¥å¤„ç†å†…å®¹
            // å¦åˆ™ä½¿ç”¨åŸå§‹è¡Œ

            // å¿½ç•¥æ•°å­—ï¼ˆé»˜è®¤å¯ç”¨ï¼Œå› ä¸ºæ—¥å¿—é€šå¸¸åŒ…å«å˜é‡æ•°å­—ï¼‰
            if (document.getElementById('ignoreNumbers')?.checked) {
                normalized = normalized.replace(/\b\d+\b/g, '[NUM]');
            }

            // ç§»é™¤UUIDå’Œå“ˆå¸Œ
            normalized = normalized.replace(
                /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,
                '[UUID]'
            );
            normalized = normalized.replace(/[0-9a-f]{32,}/gi, '[HASH]');

            // ç§»é™¤IPåœ°å€
            normalized = normalized.replace(/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g, '[IP]');

            // ç§»é™¤å¸¸è§çš„æ—¶é—´æ ¼å¼
            normalized = normalized.replace(/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/g, '[TIME]');
            normalized = normalized.replace(/\d{2}:\d{2}:\d{2}/g, '[TIME]');

            return normalized.trim();
        }

        // è®¡ç®—æ—¥å¿—çš„é‡è¦ç¨‹åº¦ï¼ˆå¯å‘å¼è¯„åˆ†ï¼‰
        function calculateImportanceScore(parsedLog) {
            let score = 0;

            // TRACE æ—¥å¿—åˆ†æ•°æœ€ä½
            if (parsedLog.level === 'TRACE') score -= 10;
            if (parsedLog.level === 'DEBUG') score -= 5;
            if (parsedLog.level === 'INFO') score += 0;
            if (parsedLog.level === 'WARN') score += 5;
            if (parsedLog.level === 'ERROR') score += 10;
            if (parsedLog.level === 'FATAL') score += 15;

            // çŸ­æ—¥å¿—ï¼ˆå¦‚ "ret 1", "Enter Function"ï¼‰é‡è¦æ€§ä½
            const contentLen = (parsedLog.content || '').length;
            if (contentLen < 20) score -= 5;
            if (contentLen < 10) score -= 5;

            // åŒ…å«å…³é”®å­—çš„æ—¥å¿—é‡è¦æ€§é«˜
            const keywords = ['error', 'fail', 'exception', 'crash', 'timeout', 'denied', 'invalid'];
            keywords.forEach(kw => {
                if (parsedLog.content && parsedLog.content.toLowerCase().includes(kw)) {
                    score += 3;
                }
            });

            // åŒ…å« "Enter Function", "ret" ç­‰å‡½æ•°è°ƒç”¨æ—¥å¿—é‡è¦æ€§ä½
            if (parsedLog.content) {
                const lowerContent = parsedLog.content.toLowerCase();
                if (lowerContent.startsWith('enter function') ||
                    lowerContent.startsWith('ret ') ||
                    lowerContent.match(/^set\s+\w+\s+\[?\]?\s*$/) ||
                    lowerContent.match(/^set\s+curl\s*/)) {
                    score -= 8;
                }
            }

            return score;
        }

        function updateStats(fileCount, totalLines, uniqueLogs, duplicates) {
            document.getElementById('totalFiles').textContent = fileCount;
            document.getElementById('totalLines').textContent = formatNumber(totalLines);
            document.getElementById('uniqueLogs').textContent = formatNumber(uniqueLogs);

            const duplicateCount = duplicates.reduce((sum, item) => sum + item.count, 0);
            const duplicateRate = totalLines > 0 ? ((duplicateCount / totalLines) * 100).toFixed(2) : 0;
            document.getElementById('duplicateRate').textContent = duplicateRate + '%';

            // æ˜¾ç¤ºä½¿ç”¨çš„ç®—æ³•
            const algorithm = document.getElementById('algorithmSelect').value;
            const algoNames = {
                'exact': 'ç²¾ç¡®åŒ¹é…',
                'fuzzy': 'Levenshtein',
                'ngram': 'N-gram',
                'jaccard': 'Jaccard',
                'cosine': 'ä½™å¼¦'
            };
            document.getElementById('usedAlgorithm').textContent = algoNames[algorithm] || algorithm;

            document.getElementById('statsSection').style.display = 'block';
        }

        function displayResults() {
            const topN = parseInt(document.getElementById('topN').value) || 20;
            const topResults = analysisResults.slice(0, topN);
            const totalLines = analysisResults.reduce((sum, item) => sum + item.count, 0);
            const sampleCount = Math.min(parseInt(document.getElementById('sampleCount').value) || 3, 10);

            const tableBody = document.getElementById('resultsTable');
            tableBody.innerHTML = '';

            topResults.forEach((item, index) => {
                const percentage = totalLines > 0 ? ((item.count / totalLines) * 100).toFixed(2) : 0;
                const row = document.createElement('tr');

                const percentageClass = percentage >= 5 ? 'percentage-high' :
                                       percentage >= 1 ? 'percentage-medium' : 'percentage-low';

                // é‡è¦æ€§ç­‰çº§
                const importanceScore = item.importanceScore || 0;
                let importanceClass = 'importance-low';
                let importanceLabel = 'ä½';
                if (importanceScore >= 8) {
                    importanceClass = 'importance-high';
                    importanceLabel = 'é«˜';
                } else if (importanceScore >= 3) {
                    importanceClass = 'importance-medium';
                    importanceLabel = 'ä¸­';
                }

                // ç”Ÿæˆä¼˜åŒ–å»ºè®®
                let suggestion = '';
                const parsed = parseLogLine(item.content);
                const lowerContent = (parsed.content || item.content).toLowerCase();

                if (parsed.level === 'TRACE' || parsed.level === 'DEBUG') {
                    if (percentage >= 1) {
                        suggestion = '<span class="suggestion-tag">å»ºè®®: è°ƒæ•´æ—¥å¿—ç­‰çº§</span>';
                    }
                } else if (lowerContent.startsWith('enter function') ||
                           lowerContent.match(/^ret\s+\d+/) ||
                           lowerContent.match(/^set\s+\w+\s*\[?\]?\s*$/)) {
                    if (percentage >= 0.5) {
                        suggestion = '<span class="suggestion-tag">å»ºè®®: å…³é—­å‡½æ•°è°ƒç”¨æ—¥å¿—</span>';
                    }
                }

                // å‡†å¤‡éšæœºæ ·æœ¬
                const samples = item.samples || [];
                const randomSamples = samples
                    .sort(() => Math.random() - 0.5)
                    .slice(0, sampleCount);

                let samplesHtml = '';
                if (randomSamples.length > 0) {
                    samplesHtml = `
                        <div class="sample-section">
                            <div class="sample-title">ğŸ“ éšæœºæ ·æœ¬ (${randomSamples.length}æ¡):</div>
                            ${randomSamples.map(sample =>
                                `<div class="sample-item">${escapeHtml(sample)}</div>`
                            ).join('')}
                        </div>
                    `;
                }

                // æ ‡è®°æ˜¯å¦ä¸ºèšåˆç»„
                const groupTag = item.isGroup ? ' <span style="background:#ffa502;color:white;padding:2px 6px;border-radius:4px;font-size:10px;">èšåˆ</span>' : '';

                row.innerHTML = `
                    <td class="rank">#${index + 1}</td>
                    <td class="percentage">
                        <span class="percentage-badge ${percentageClass}">${percentage}%</span>
                    </td>
                    <td class="count">${formatNumber(item.count)}</td>
                    <td class="importance">
                        <span class="importance-badge ${importanceClass}">${importanceLabel}</span>
                    </td>
                    <td class="log-content">
                        <div>${escapeHtml(item.content)}${groupTag}${suggestion}</div>
                        ${samplesHtml}
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // æ›´æ–°å›¾è¡¨
            updateBarChart(topResults.slice(0, 10), totalLines);

            document.getElementById('resultsSection').style.display = 'block';

            // æ˜¾ç¤ºä¼˜åŒ–å»ºè®®ç»Ÿè®¡
            showOptimizationSummary(topResults);
        }

        function showOptimizationSummary(results) {
            let highValueLogs = 0;
            let lowValueLogs = 0;
            let potentialSpaceSaving = 0;

            results.forEach(item => {
                if (item.importanceScore >= 3) {
                    highValueLogs += item.count;
                } else {
                    lowValueLogs += item.count;
                }
            });

            const totalLines = results.reduce((sum, item) => sum + item.count, 0);
            const lowValueRatio = totalLines > 0 ? ((lowValueLogs / totalLines) * 100).toFixed(2) : 0;

            // ä¼°ç®—ä¼˜åŒ–ç©ºé—´
            if (totalLines > 0 && lowValueLogs > 0) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'warning-box';
                summaryDiv.style.background = '#d4edda';
                summaryDiv.style.borderColor = '#28a745';
                summaryDiv.style.color = '#155724';
                summaryDiv.style.marginTop = '20px';
                summaryDiv.innerHTML = `
                    <strong>ğŸ“Š æ—¥å¿—ä¼˜åŒ–å»ºè®®æ€»ç»“ï¼š</strong><br>
                    - ä½ä»·å€¼æ—¥å¿—å æ¯”: <strong>${lowValueRatio}%</strong> (${formatNumber(lowValueLogs)}è¡Œ)<br>
                    - å¦‚æœå…³é—­è¿™äº›ä½ä»·å€¼æ—¥å¿—ï¼Œé¢„è®¡å¯èŠ‚çœ <strong>${lowValueRatio}%</strong> çš„æ—¥å¿—ç©ºé—´<br>
                    - å»ºè®®ä¼˜å…ˆä¼˜åŒ– TRACE/DEBUG çº§åˆ«å’Œå‡½æ•°è°ƒç”¨æ—¥å¿—
                `;

                const chartContainer = document.getElementById('barChart');
                chartContainer.parentNode.insertBefore(summaryDiv, chartContainer);
            }
        }

        function updateBarChart(topResults, totalLines) {
            const chartContainer = document.getElementById('barChart');
            chartContainer.innerHTML = '';

            topResults.forEach((item, index) => {
                const percentage = totalLines > 0 ? ((item.count / totalLines) * 100).toFixed(2) : 0;
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';

                const truncatedContent = item.content.length > 50 ?
                    item.content.substring(0, 50) + '...' : item.content;

                barItem.innerHTML = `
                    <div class="bar-label">#${index + 1}</div>
                    <div class="bar-wrapper">
                        <div class="bar" style="width: ${Math.min(percentage * 5, 100)}%">
                            ${percentage}%
                        </div>
                    </div>
                `;
                chartContainer.appendChild(barItem);
            });
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = 'âŒ ' + message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function clearResults() {
            analysisResults = [];
            document.getElementById('resultsTable').innerHTML = '';
            document.getElementById('barChart').innerHTML = '';

            const summaryElements = document.querySelectorAll('.chart-container .warning-box');
            summaryElements.forEach(el => el.remove());

            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('realtimeResults').style.display = 'none';
            hideError();
        }

        function exportResults() {
            if (analysisResults.length === 0) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
                return;
            }

            let csv = 'æ’å,å æ¯”(%),é‡å¤æ¬¡æ•°,é‡è¦æ€§è¯„åˆ†,æ˜¯å¦èšåˆ,æ—¥å¿—æ¨¡æ¿,æ ·æœ¬æ—¥å¿—1,æ ·æœ¬æ—¥å¿—2,æ ·æœ¬æ—¥å¿—3\n';
            const totalLines = analysisResults.reduce((sum, item) => sum + item.count, 0);

            analysisResults.forEach((item, index) => {
                const percentage = totalLines > 0 ? ((item.count / totalLines) * 100).toFixed(2) : 0;
                const escapedContent = `"${item.content.replace(/"/g, '""')}"`;

                // æå–æ ·æœ¬
                const samples = item.samples || [];
                const sample1 = samples[0] ? `"${samples[0].replace(/"/g, '""')}"` : '""';
                const sample2 = samples[1] ? `"${samples[1].replace(/"/g, '""')}"` : '""';
                const sample3 = samples[2] ? `"${samples[2].replace(/"/g, '""')}"` : '""';

                csv += `${index + 1},${percentage},${item.count},${item.importanceScore || 0},${item.isGroup ? 'æ˜¯' : 'å¦'},${escapedContent},${sample1},${sample2},${sample3}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `log_analysis_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function formatNumber(num) {
            return num.toLocaleString('zh-CN');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç›‘å¬æ˜¾ç¤ºæ•°é‡å˜åŒ–
        document.getElementById('topN').addEventListener('change', function() {
            if (analysisResults.length > 0) {
                displayResults();
            }
        });
    </script>
</body>
</html>
