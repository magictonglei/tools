<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—é‡å¤åº¦åˆ†æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #856404;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-analyze:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-clear {
            background: #ff6b6b;
            color: white;
        }

        .btn-clear:hover {
            background: #ee5a5a;
        }

        .progress-section {
            display: none;
            margin: 25px 0;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 25px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .stats-section {
            display: none;
            background: #f0f7ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .results-section {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .results-header h2 {
            color: #333;
            font-size: 20px;
        }

        .filter-options {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-options label {
            margin-bottom: 0;
            font-weight: normal;
        }

        .filter-options input[type="number"] {
            width: 80px;
            padding: 8px;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .log-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .log-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }

        .log-table tr:hover {
            background: #f8f9fa;
        }

        .rank {
            width: 60px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        .percentage {
            width: 100px;
            text-align: center;
        }

        .percentage-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
        }

        .percentage-high {
            background: #ff6b6b;
            color: white;
        }

        .percentage-medium {
            background: #ffa502;
            color: white;
        }

        .percentage-low {
            background: #20bf6b;
            color: white;
        }

        .count {
            width: 80px;
            text-align: center;
            color: #666;
        }

        .log-content {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            word-break: break-all;
            line-height: 1.5;
            max-width: 600px;
        }

        .sample-section {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .sample-title {
            font-size: 11px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .sample-item {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 11px;
            color: #555;
            padding: 6px 0;
            border-bottom: 1px dashed #e0e0e0;
            word-break: break-all;
        }

        .sample-item:last-child {
            border-bottom: none;
        }

        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            width: 60px;
            font-size: 12px;
            color: #666;
            text-align: right;
        }

        .bar-wrapper {
            flex: 1;
            background: #e0e0e0;
            border-radius: 4px;
            height: 30px;
            overflow: hidden;
        }

        .bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .export-btn {
            background: #20bf6b;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .export-btn:hover {
            background: #1ea864;
        }

        .error-message {
            display: none;
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #d63031;
        }

        .settings-toggle {
            cursor: pointer;
            color: #667eea;
            text-decoration: underline;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        .settings-panel {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .settings-panel.show {
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æ—¥å¿—é‡å¤åº¦åˆ†æå·¥å…·</h1>

        <div class="error-message" id="errorMessage"></div>

        <div class="input-section">
            <div class="input-group">
                <label>ğŸ“ æ—¥å¿—ç›®å½•è·¯å¾„</label>
                <input type="text" id="directoryInput" 
                       placeholder="ä¾‹å¦‚: G:\path\to\logs"
                       value="G:\[________________]\DiagnosticLog-171-1766458290-sf\iOADiagnosisLog-Full-2025-12-23-10-52-51\diagnosis_export\ZtsmEnt">
            </div>

            <div class="input-group">
                <label>ğŸ” æ—¥å¿—æ–‡ä»¶åŒ¹é…æ¨¡å¼ï¼ˆæ”¯æŒé€šé…ç¬¦ * å’Œ ?ï¼‰</label>
                <input type="text" id="patternInput" 
                       placeholder="ä¾‹å¦‚: ZtsmEnt_*.log"
                       value="ZtsmEnt_*.log">
            </div>

            <div class="warning-box">
                âš ï¸ <strong>æ€§èƒ½æç¤ºï¼š</strong>åˆ†æå¤§æ–‡ä»¶ï¼ˆ50MB+ï¼‰éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚å¦‚é‡å¡é¡¿ï¼Œè¯·å…³é—­"å¯ç”¨æ¨¡ç³ŠåŒ¹é…"é€‰é¡¹ã€‚
            </div>

            <span class="settings-toggle" id="settingsToggle">âš™ï¸ é«˜çº§è®¾ç½®</span>
            <div class="settings-panel" id="settingsPanel">
                <div class="input-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="ignoreTimestamp" checked>
                        <label for="ignoreTimestamp">å¿½ç•¥æ—¶é—´æˆ³ï¼ˆè¯†åˆ«ç›¸ä¼¼æ—¥å¿—å†…å®¹ï¼‰</label>
                    </div>
                </div>
                <div class="input-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="ignoreNumbers" checked>
                        <label for="ignoreNumbers">å¿½ç•¥æ•°å­—ï¼ˆè¯†åˆ«æ¨¡æ¿æ¨¡æ¿æ—¥å¿—ï¼‰</label>
                    </div>
                </div>
                <div class="input-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="useFuzzyMatch">
                        <label for="useFuzzyMatch">å¯ç”¨æ¨¡ç³ŠåŒ¹é…ï¼ˆåŸºäºç›¸ä¼¼åº¦èšåˆæ—¥å¿—ï¼Œè¾ƒæ…¢ï¼‰</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0-100ï¼Œå€¼è¶Šé«˜è¦æ±‚è¶Šä¸¥æ ¼ï¼‰</label>
                    <input type="number" id="similarityThreshold" value="70" min="0" max="100">
                </div>
                <div class="input-group">
                    <label>æœ€å°é‡å¤æ¬¡æ•°é˜ˆå€¼</label>
                    <input type="number" id="minRepeatCount" value="5" min="1">
                </div>
                <div class="input-group">
                    <label>è¿‡æ»¤è¿‡çŸ­æ—¥å¿—ï¼ˆæœ€å°å­—ç¬¦æ•°ï¼‰</label>
                    <input type="number" id="minLineLength" value="20" min="1">
                </div>
                <div class="input-group">
                    <label>æ¯ä¸ªæ—¥å¿—ç»„æ˜¾ç¤ºçš„éšæœºæ ·æœ¬æ•°</label>
                    <input type="number" id="sampleCount" value="3" min="1" max="10">
                </div>
            </div>

            <div class="btn-container">
                <button class="btn-analyze" id="analyzeBtn" onclick="analyzeLogs()">ğŸ” å¼€å§‹åˆ†æ</button>
                <button class="btn-clear" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
        </div>

        <div class="stats-section" id="statsSection">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalFiles">0</div>
                    <div class="stat-label">åˆ†ææ–‡ä»¶æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalLines">0</div>
                    <div class="stat-label">æ€»æ—¥å¿—è¡Œæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uniqueLogs">0</div>
                    <div class="stat-label">å”¯ä¸€æ—¥å¿—æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="duplicateRate">0%</div>
                    <div class="stat-label">é‡å¤ç‡</div>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>ğŸ“‹ é‡å¤æ—¥å¿—åˆ†æç»“æœ</h2>
                <div class="filter-options">
                    <label>æ˜¾ç¤ºå‰</label>
                    <input type="number" id="topN" value="20" min="1" max="1000">
                    <label>æ¡</label>
                    <button class="export-btn" onclick="exportResults()">ğŸ“¥ å¯¼å‡ºCSV</button>
                </div>
            </div>

            <table class="log-table">
                <thead>
                    <tr>
                        <th class="rank">æ’å</th>
                        <th class="percentage">å æ¯”</th>
                        <th class="count">é‡å¤æ¬¡æ•°</th>
                        <th class="log-content">æ—¥å¿—æ¨¡æ¿</th>
                    </tr>
                </thead>
                <tbody id="resultsTable">
                </tbody>
            </table>

            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ TOP 10 é‡å¤æ—¥å¿—åˆ†å¸ƒ</div>
                <div class="bar-chart" id="barChart"></div>
            </div>
        </div>
    </div>

    <script>
        let analysisResults = [];
        let isAnalyzing = false;

        // åˆ‡æ¢é«˜çº§è®¾ç½®é¢æ¿
        document.getElementById('settingsToggle').addEventListener('click', function() {
            document.getElementById('settingsPanel').classList.toggle('show');
        });

        // è®¡ç®—ç¼–è¾‘è·ç¦»ï¼ˆLevenshteinè·ç¦»ï¼‰- ä¼˜åŒ–ç‰ˆæœ¬ï¼Œé™åˆ¶æœ€å¤§é•¿åº¦
        function levenshteinDistance(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;

            if (len1 === 0) return len2;
            if (len2 === 0) return len1;

            // å¦‚æœå­—ç¬¦ä¸²å¤ªé•¿ï¼Œä½¿ç”¨ç®€åŒ–çš„æ¯”è¾ƒ
            if (len1 > 500 || len2 > 500) {
                return simpleDistance(str1, str2);
            }

            const matrix = [];

            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j - 1] + cost
                    );
                }
            }

            return matrix[len1][len2];
        }

        // ç®€åŒ–çš„è·ç¦»è®¡ç®—ï¼ˆç”¨äºé•¿å­—ç¬¦ä¸²ï¼‰
        function simpleDistance(str1, str2) {
            // å–å‰200å’Œå200å­—ç¬¦æ¯”è¾ƒ
            const len1 = Math.min(str1.length, 200);
            const len2 = Math.min(str2.length, 200);

            const prefix1 = str1.substring(0, len1);
            const prefix2 = str2.substring(0, len2);

            // ä½¿ç”¨ç®€å•çš„å•è¯åŒ¹é…
            const words1 = new Set(prefix1.split(/\s+/).filter(w => w.length > 2));
            const words2 = new Set(prefix2.split(/\s+/).filter(w => w.length > 2));

            let common = 0;
            words1.forEach(word => {
                if (words2.has(word)) common++;
            });

            const total = Math.max(words1.size, words2.size);
            if (total === 0) return 0;

            return Math.floor((total - common) * 3);
        }

        // è®¡ç®—ç›¸ä¼¼åº¦ç™¾åˆ†æ¯”
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 100;
            if (!str1 || !str2) return 0;

            const maxLen = Math.max(str1.length, str2.length);
            if (maxLen === 0) return 100;

            const distance = levenshteinDistance(str1, str2);
            const similarity = ((maxLen - distance) / maxLen) * 100;

            return Math.max(0, Math.min(100, Math.round(similarity * 100) / 100));
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆæ—¥å¿—è¡Œï¼ˆè¿‡æ»¤æ‰åªæœ‰ç¬¦å·çš„è¡Œï¼‰
        function isValidLogLine(line) {
            const minLineLength = parseInt(document.getElementById('minLineLength').value) || 10;
            if (line.length < minLineLength) return false;

            // ç§»é™¤æ‰€æœ‰ç¬¦å·å’Œç©ºç™½
            const stripped = line.replace(/[{}[\](),;:.\/\s\n\r\t]/g, '');
            return stripped.length > 0;
        }

        // æµå¼è¯»å–æ–‡ä»¶å†…å®¹ï¼Œé¿å…å†…å­˜çˆ†ç‚¸
        async function* readFileInChunks(file, chunkSize = 1024 * 1024) { // 1MB chunks
            const reader = file.stream().getReader();
            let buffer = '';
            let position = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const decoder = new TextDecoder('utf-8', { stream: true });
                const chunk = buffer + decoder.decode(value, { stream: true });

                // æŒ‰è¡Œåˆ†å‰²
                const lines = chunk.split('\n');
                // ä¿ç•™æœ€åä¸€è¡Œï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰
                buffer = lines.pop() || '';

                for (const line of lines) {
                    yield line;
                }

                position += value.length;
            }

            // å¤„ç†æœ€åä¸€è¡Œ
            if (buffer) {
                yield buffer;
            }
        }

        async function analyzeLogs() {
            if (isAnalyzing) return;
            isAnalyzing = true;

            const directory = document.getElementById('directoryInput').value.trim();
            const pattern = document.getElementById('patternInput').value.trim();

            if (!directory) {
                showError('è¯·è¾“å…¥æ—¥å¿—ç›®å½•è·¯å¾„');
                isAnalyzing = false;
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'â³ åˆ†æä¸­...';

            hideError();
            showProgress();
            updateProgress(0, 'å¼€å§‹åˆ†æ...');

            try {
                // ä½¿ç”¨File System Access APIé€‰æ‹©ç›®å½•
                const dirHandle = await window.showDirectoryPicker({
                    id: 'log-analyzer-dir',
                    mode: 'read'
                });

                analysisResults = [];
                let totalLines = 0;
                let fileCount = 0;
                const logMap = new Map(); // å­˜å‚¨è§„èŒƒåŒ–åçš„æ—¥å¿—åŠå…¶è®¡æ•°å’Œæ ·æœ¬
                const useFuzzyMatch = document.getElementById('useFuzzyMatch').checked;
                const similarityThreshold = parseInt(document.getElementById('similarityThreshold').value) || 70;

                // è·å–æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶
                const filesToProcess = [];
                for await (const [name, handle] of dirHandle.entries()) {
                    if (handle.kind === 'file' && matchPattern(name, pattern)) {
                        filesToProcess.push({ name, handle });
                    }
                }
                fileCount = filesToProcess.length;

                // æµå¼å¤„ç†æ¯ä¸ªæ–‡ä»¶
                for (let fileIdx = 0; fileIdx < filesToProcess.length; fileIdx++) {
                    const { name, handle } = filesToProcess[fileIdx];
                    const fileProgress = 10 + (fileIdx / filesToProcess.length) * 35;
                    updateProgress(fileProgress, `æ­£åœ¨è¯»å–æ–‡ä»¶ (${fileIdx + 1}/${fileCount}): ${name}...`);

                    const file = await handle.getFile();
                    let lineCountInFile = 0;

                    // æµå¼è¯»å–
                    for await (const line of readFileInChunks(file)) {
                        const trimmedLine = line.trim();
                        if (trimmedLine && isValidLogLine(trimmedLine)) {
                            totalLines++;
                            lineCountInFile++;
                            const normalizedLine = normalizeLine(trimmedLine);

                            if (!logMap.has(normalizedLine)) {
                                logMap.set(normalizedLine, {
                                    count: 0,
                                    samples: [] // å­˜å‚¨åŸå§‹æ—¥å¿—æ ·æœ¬
                                });
                            }

                            const logEntry = logMap.get(normalizedLine);
                            logEntry.count++;

                            // åªä¿å­˜æ ·æœ¬ï¼ˆé™åˆ¶å†…å­˜ï¼‰
                            if (logEntry.samples.length < 10) {
                                logEntry.samples.push(trimmedLine);
                            }
                        }

                        // æ¯å¤„ç†1000è¡Œé‡Šæ”¾ä¸€ä¸‹ä¸»çº¿ç¨‹
                        if (lineCountInFile % 1000 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 0));
                        }
                    }
                }

                updateProgress(50, `æ­£åœ¨è¿›è¡Œç›¸ä¼¼åº¦åˆ†æ...`);

                let resultsArray;

                if (useFuzzyMatch) {
                    // ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…èšåˆç›¸ä¼¼æ—¥å¿—ï¼ˆç°åœ¨æ˜¯å¼‚æ­¥å‡½æ•°ï¼‰
                    resultsArray = await groupSimilarLogs(Array.from(logMap.entries()), similarityThreshold);
                } else {
                    // ç›´æ¥ä½¿ç”¨ç²¾ç¡®åŒ¹é…ç»“æœ
                    resultsArray = Array.from(logMap.entries()).map(([content, data]) => ({
                        content,
                        count: data.count,
                        samples: data.samples,
                        isGroup: false
                    }));
                }

                // è¿‡æ»¤æœ€å°é‡å¤æ¬¡æ•°
                const minRepeatCount = parseInt(document.getElementById('minRepeatCount').value) || 5;
                resultsArray = resultsArray.filter(item => item.count >= minRepeatCount);

                // æ’åº
                resultsArray.sort((a, b) => b.count - a.count);

                analysisResults = resultsArray;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats(fileCount, totalLines, logMap.size, analysisResults);

                // æ˜¾ç¤ºç»“æœ
                displayResults();
                updateProgress(100, 'åˆ†æå®Œæˆï¼');

            } catch (error) {
                console.error('åˆ†æé”™è¯¯:', error);
                showError('åˆ†æå¤±è´¥: ' + error.message);
            } finally {
                isAnalyzing = false;
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ğŸ” å¼€å§‹åˆ†æ';
            }
        }

        // ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…èšåˆç›¸ä¼¼æ—¥å¿— - ä¼˜åŒ–æ€§èƒ½
        async function groupSimilarLogs(logs, threshold) {
            const groups = [];
            const used = new Set();

            // æŒ‰å‡ºç°æ¬¡æ•°æ’åºï¼Œä¼˜å…ˆå¤„ç†é«˜é¢‘æ—¥å¿—
            const sortedLogs = logs.sort((a, b) => b[1].count - a[1].count);

            // æ€§èƒ½ä¼˜åŒ–ï¼šåªå¯¹é«˜é¢‘æ—¥å¿—è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
            const maxProcessCount = Math.min(sortedLogs.length, 2000);
            const processLogs = sortedLogs.slice(0, maxProcessCount);

            let processedCount = 0;
            const totalToProcess = processLogs.length;

            for (let i = 0; i < processLogs.length; i++) {
                const idx = i;
                if (used.has(idx)) continue;

                const [content, data] = processLogs[idx];
                let group = {
                    content,
                    count: data.count,
                    samples: [...data.samples],
                    similarCount: 0,
                    isGroup: false
                };

                // æŸ¥æ‰¾ç›¸ä¼¼çš„æ—¥å¿— - é™åˆ¶æ¯”è¾ƒèŒƒå›´
                const maxCompare = Math.min(processLogs.length, i + 500);
                const similarLogs = [];

                for (let j = i + 1; j < maxCompare; j++) {
                    if (used.has(j)) continue;

                    const [otherContent, otherData] = processLogs[j];

                    // å¿«é€Ÿè¿‡æ»¤ï¼šé•¿åº¦å·®å¼‚å¤ªå¤§ç›´æ¥è·³è¿‡
                    const lenDiff = Math.abs(content.length - otherContent.length);
                    if (lenDiff > content.length * 0.3) continue;

                    const similarity = calculateSimilarity(content, otherContent);

                    if (similarity >= threshold) {
                        similarLogs.push({ content: otherContent, data: otherData, idx: j });
                    }
                }

                if (similarLogs.length > 0) {
                    // åˆå¹¶ç›¸ä¼¼æ—¥å¿—
                    let totalCount = data.count;
                    let allSamples = [...data.samples];

                    similarLogs.forEach(item => {
                        totalCount += item.data.count;
                        allSamples = allSamples.concat(item.data.samples.slice(0, 5));
                        used.add(item.idx);
                        group.similarCount++;
                    });

                    group.count = totalCount;
                    group.samples = allSamples;
                    group.isGroup = true;
                    group.content = `${content} (å·²èšåˆ ${group.similarCount + 1} æ¡ç›¸ä¼¼æ—¥å¿—)`;
                }

                groups.push(group);
                used.add(idx);

                // å®šæœŸæ›´æ–°è¿›åº¦
                processedCount++;
                if (processedCount % 50 === 0) {
                    const progress = 50 + (processedCount / totalToProcess) * 45;
                    updateProgress(Math.min(progress, 95), `æ­£åœ¨è¿›è¡Œç›¸ä¼¼åº¦åˆ†æ (${processedCount}/${totalToProcess})...`);

                    // è®©UIæœ‰æœºä¼šæ›´æ–°
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }

            // æ·»åŠ å‰©ä½™çš„ä½é¢‘æ—¥å¿—ï¼ˆä¸è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ï¼‰
            for (let i = maxProcessCount; i < sortedLogs.length; i++) {
                if (!used.has(i)) {
                    const [content, data] = sortedLogs[i];
                    groups.push({
                        content,
                        count: data.count,
                        samples: data.samples,
                        isGroup: false
                    });
                }
            }

            return groups;
        }

        function matchPattern(filename, pattern) {
            const regexPattern = pattern
                .replace(/\./g, '\\.')
                .replace(/\*/g, '.*')
                .replace(/\?/g, '.');
            const regex = new RegExp(`^${regexPattern}$`, 'i');
            return regex.test(filename);
        }

        function normalizeLine(line) {
            let normalized = line;

            // å¿½ç•¥æ—¶é—´æˆ³
            if (document.getElementById('ignoreTimestamp').checked) {
                // åŒ¹é…å¸¸è§çš„æ—¶é—´æˆ³æ ¼å¼: 2024-12-23 10:52:51, [2024-12-23], 10:52:51 ç­‰
                normalized = normalized.replace(
                    /\d{4}[-/]\d{1,2}[-/]\d{1,2}[\sT]+\d{1,2}:\d{1,2}:\d{1,2}(?:\.\d+)?/g,
                    '[TIMESTAMP]'
                );
                normalized = normalized.replace(/\[\d{4}-\d{1,2}-\d{1,2}\]/g, '[DATE]');
                normalized = normalized.replace(/\d{1,2}:\d{1,2}:\d{1,2}(?:\.\d+)?/g, '[TIME]');
            }

            // å¿½ç•¥æ•°å­—
            if (document.getElementById('ignoreNumbers').checked) {
                normalized = normalized.replace(/\b\d+\b/g, '[NUM]');
            }

            // ç§»é™¤UUIDå’Œå“ˆå¸Œ
            normalized = normalized.replace(
                /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,
                '[UUID]'
            );
            normalized = normalized.replace(/[0-9a-f]{32,}/gi, '[HASH]');

            return normalized.trim();
        }

        function updateStats(fileCount, totalLines, uniqueLogs, duplicates) {
            document.getElementById('totalFiles').textContent = fileCount;
            document.getElementById('totalLines').textContent = formatNumber(totalLines);
            document.getElementById('uniqueLogs').textContent = formatNumber(uniqueLogs);

            const duplicateCount = duplicates.reduce((sum, item) => sum + item.count, 0);
            const duplicateRate = totalLines > 0 ? ((duplicateCount / totalLines) * 100).toFixed(2) : 0;
            document.getElementById('duplicateRate').textContent = duplicateRate + '%';

            document.getElementById('statsSection').style.display = 'block';
        }

        function displayResults() {
            const topN = parseInt(document.getElementById('topN').value) || 20;
            const topResults = analysisResults.slice(0, topN);
            const totalLines = analysisResults.reduce((sum, item) => sum + item.count, 0);
            const sampleCount = Math.min(parseInt(document.getElementById('sampleCount').value) || 3, 10);

            const tableBody = document.getElementById('resultsTable');
            tableBody.innerHTML = '';

            topResults.forEach((item, index) => {
                const percentage = totalLines > 0 ? ((item.count / totalLines) * 100).toFixed(2) : 0;
                const row = document.createElement('tr');

                const percentageClass = percentage >= 5 ? 'percentage-high' :
                                       percentage >= 1 ? 'percentage-medium' : 'percentage-low';

                // å‡†å¤‡éšæœºæ ·æœ¬
                const samples = item.samples || [];
                const randomSamples = samples
                    .sort(() => Math.random() - 0.5)
                    .slice(0, sampleCount);

                let samplesHtml = '';
                if (randomSamples.length > 0) {
                    samplesHtml = `
                        <div class="sample-section">
                            <div class="sample-title">ğŸ“ éšæœºæ ·æœ¬ (${randomSamples.length}æ¡):</div>
                            ${randomSamples.map(sample =>
                                `<div class="sample-item">${escapeHtml(sample)}</div>`
                            ).join('')}
                        </div>
                    `;
                }

                // æ ‡è®°æ˜¯å¦ä¸ºèšåˆç»„
                const groupTag = item.isGroup ? ' <span style="background:#ffa502;color:white;padding:2px 6px;border-radius:4px;font-size:10px;">èšåˆ</span>' : '';

                row.innerHTML = `
                    <td class="rank">#${index + 1}</td>
                    <td class="percentage">
                        <span class="percentage-badge ${percentageClass}">${percentage}%</span>
                    </td>
                    <td class="count">${formatNumber(item.count)}</td>
                    <td class="log-content">
                        <div>${escapeHtml(item.content)}${groupTag}</div>
                        ${samplesHtml}
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // æ›´æ–°å›¾è¡¨
            updateBarChart(topResults.slice(0, 10), totalLines);

            document.getElementById('resultsSection').style.display = 'block';
        }

        function updateBarChart(topResults, totalLines) {
            const chartContainer = document.getElementById('barChart');
            chartContainer.innerHTML = '';

            topResults.forEach((item, index) => {
                const percentage = totalLines > 0 ? ((item.count / totalLines) * 100).toFixed(2) : 0;
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';

                const truncatedContent = item.content.length > 50 ?
                    item.content.substring(0, 50) + '...' : item.content;

                barItem.innerHTML = `
                    <div class="bar-label">#${index + 1}</div>
                    <div class="bar-wrapper">
                        <div class="bar" style="width: ${Math.min(percentage * 5, 100)}%">
                            ${percentage}%
                        </div>
                    </div>
                `;
                chartContainer.appendChild(barItem);
            });
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = 'âŒ ' + message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function clearResults() {
            analysisResults = [];
            document.getElementById('resultsTable').innerHTML = '';
            document.getElementById('barChart').innerHTML = '';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            hideError();
        }

        function exportResults() {
            if (analysisResults.length === 0) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
                return;
            }

            let csv = 'æ’å,å æ¯”(%),é‡å¤æ¬¡æ•°,æ˜¯å¦èšåˆ,æ—¥å¿—æ¨¡æ¿,æ ·æœ¬æ—¥å¿—1,æ ·æœ¬æ—¥å¿—2,æ ·æœ¬æ—¥å¿—3\n';
            const totalLines = analysisResults.reduce((sum, item) => sum + item.count, 0);

            analysisResults.forEach((item, index) => {
                const percentage = totalLines > 0 ? ((item.count / totalLines) * 100).toFixed(2) : 0;
                const escapedContent = `"${item.content.replace(/"/g, '""')}"`;

                // æå–æ ·æœ¬
                const samples = item.samples || [];
                const sample1 = samples[0] ? `"${samples[0].replace(/"/g, '""')}"` : '""';
                const sample2 = samples[1] ? `"${samples[1].replace(/"/g, '""')}"` : '""';
                const sample3 = samples[2] ? `"${samples[2].replace(/"/g, '""')}"` : '""';

                csv += `${index + 1},${percentage},${item.count},${item.isGroup ? 'æ˜¯' : 'å¦'},${escapedContent},${sample1},${sample2},${sample3}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `log_analysis_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function formatNumber(num) {
            return num.toLocaleString('zh-CN');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç›‘å¬æ˜¾ç¤ºæ•°é‡å˜åŒ–
        document.getElementById('topN').addEventListener('change', function() {
            if (analysisResults.length > 0) {
                displayResults();
            }
        });
    </script>
</body>
</html>
